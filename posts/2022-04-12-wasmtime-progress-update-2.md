---
layout: post
title: "More progress porting wasmtime to Theseus"
author: Kevin Boos <https://github.com/kevinaboos>
release: false
---

## The ~quest~ port continues!

This post covers the highlights of our ongoing work to port `wasmtime` to Theseus; see the previous post(s) for more information.

### Completed initial port of `wasmtime-runtime`!
Last time we left off having finished several key features to support the needs of the `wasmtime-runtime` crate:
* Thread-Local Storage (TLS)
* Creation and management of Unix-like memory-mapped areas via the `region` and `libc` crates
  * Plus additions to `tlibc`, the Theseus-specific implementation of basic libc functions 
* Reading/writing of object files via the `object` crate
* Improvements to Theseus's `page_allocator` and `theseus_cargo` build tool 

Over the past several weeks, we have completed our modifications to `wasmtime-runtime` such that it now builds properly on Theseus!
The key missing parts were:

|   Crate / Feature    |        Summary        | Reason Needed for `wasmtime-runtime` |
|----------------------|-----------------------|--------------------------------------|
| `backtrace`          | Rust wrapper around the actual platform-specific `libc` implementation    | Used to establish memory mappings and register signal handlers |
| `std::path`          | Cross-platform APIs for virtual memory functions  | Used to allocate large chunks of memory and remap/protect memory regions as exec/read/write as needed |
| `resume_unwind()`    | Thread-Local Storage areas | Used for `thread_local!()` macro, which is needed to handle traps and stack unwinding upon exceptions that occur while executing native code that was JIT-compiled from a WASM binary |
| `anyhow`/`thiserror` | Helper crate for reading/writing object files, e.g., ELF | Used to read object files generated by `cranelift`'s backend and to manage unwind info |
| Signal handling      |                     |                    |




* Support backtrace, which required modifying Theseus's unwinder and stack trace functionality to expose more details about their inner state, i.e., the register values on each stack frame (and also symbolication)
  * Backtrace changeset: https://github.com/theseus-os/backtrace-rs/compare/5e15d73..c56bae0


* Support `std`-like `path`s in Theseus's `no_std` environment
  * Plus syntactic sugar to use a regular `Rust` `String` and `str` as an `OsString` and `OsStr`, respectively

* Extended unwinding on Theseus to support the `resume_unwind()` function

* Better error traits and error handling for `no_std`, including adaptations of the ubiquitous `thiserror` and `anyhow`




#### `Back`(`trace`) to the Future



#### The `Path` Forwards



#### Oh, an `Error` Occurred? ~Anyway~ Anyhow...
In yet another tribute to D. Tolnay, `wasmtime` uses his `anyhow` and `thiserror` crates for convenient error handling across nearly every source file and function.



#### The Last ~Jedi~ Dependency: Signal Handling
* Signal handling
  * Required because `wasmtime` performs Just-In Time (JIT) compilation of WASM binaries into native code, so a failure or exception will translate into a native host exception, e.g., a SEGFAULT or the like.



## Miscellaneous Contributions
* Fixed issue with TLS sections, which required adding support for loading `.tbss` (TLS BSS) sections 
* Jacob's rate monotonic scheduler for pseudo-realtime tasks
  * Introduce a `sleep` crate that handles blocking a task for a given number of system ticks.
  * Supports the notion of "periodic" tasks that run a short workload, go to sleep, and then wake back up at the beginning of every X-tick period.
* Updated to the latest Rust 1.61 nightly version.
  * Required to fix the ABI issues in LLVM, wherein the `"x86-interrupt"` ABI for exception handlers didn't properly match what the CPU pushes onto the stack before jumping to said handler.
  * Needed as part of the effort to support registering third-party "signal" (exception) handlers in Theseus
* Contributed a tiny PR back to the `x86_64` crate
  * We had been using our own outdated fork of this library for a while, but I minimized Theseus's dependencies on it so we can now rely on it for only a small subset of features. This made it easier to upgrade to the latest version.
* Ramla finished implementing packet tranmission for the Mellanox 100GiB NIC
